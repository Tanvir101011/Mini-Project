#!/bin/bash

# Check if Python 3 is installed
if ! command -v python3 &> /dev/null; then
    echo "Error: Python 3 is required but not installed."
    exit 1
fi

# Check if msfvenom is installed
if ! command -v msfvenom &> /dev/null; then
    echo "Error: msfvenom is required but not installed. Install Metasploit Framework."
    exit 1
fi

# Create virtual environment
echo "Creating virtual environment..."
python3 -m venv venv

# Activate virtual environment
source venv/bin/activate

# Upgrade pip
echo "Upgrading pip..."
pip install --upgrade pip

# Install dependencies
echo "Installing dependencies..."
pip install pefile capstone

# Set up repository
REPO_PATH="/opt/binpatch"
echo "Setting up repository at $REPO_PATH..."
sudo mkdir -p "$REPO_PATH/certs"
sudo mkdir -p "$REPO_PATH/backdoored"
sudo chmod -R 755 "$REPO_PATH"

# Copy sample binary (assuming hello.exe is precompiled or compiled separately)
if [ -f "hello.exe" ]; then
    echo "Copying sample binary..."
    sudo cp hello.exe "$REPO_PATH/"
else
    echo "Warning: hello.exe not found. Compile hello.c with mingw-w64 to create it."
fi

# Verify Python version
echo "Verifying Python version..."
python --version

# Deactivate virtual environment
deactivate

echo "Setup complete! To use BinPatch, activate the virtual environment with:"
echo "source venv/bin/activate"
echo "Then run: python binpatch.py --help"
echo "Compile hello.c with 'x86_64-w64-mingw32-gcc hello.c -o hello.exe' if needed."